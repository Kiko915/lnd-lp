---
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
    const newsPosts = await getCollection('news');
    return newsPosts.map((post: NewsPost) => ({
        params: { slug: post.slug },
        props: {}
    }));
}

const { slug } = Astro.params;

// Define types for news content
type NewsPost = CollectionEntry<'news'>;
type Author = {
    name: string;
    bio: string;
    avatar: string;
};

// Fetch all news posts
const newsPosts = await getCollection('news');
const newsItem = newsPosts.find((post: NewsPost) => post.slug === slug);

// Redirect to 404 if news not found
if (!newsItem) {
    return Astro.redirect('/404');
}

// Format date helper
const formatDate = (date: string | Date) => {
    return new Date(date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
};

// Get related posts (same tags, excluding current)
const relatedPosts = newsPosts
    .filter((post: NewsPost) => 
        post.id !== newsItem.id &&
        post.data.tags.some((tag: string) => newsItem.data.tags.includes(tag))
    )
    .slice(0, 3);
---

<Layout title={`${newsItem.data.title} | Lingkod Ng Dambana`}>
    <main class="fade-in">
        <!-- Article Header -->
        <section class="relative min-h-[50vh] flex items-end bg-[#205488]">
            <div class="absolute inset-0">
                <div class="absolute inset-0 pattern-grid opacity-5"></div>
                <div class="absolute inset-0 logo-pattern opacity-[0.09] bg-repeat"></div>
                <div class="absolute inset-0 bg-gradient-to-b from-[#205488]/50 via-[#205488]/30 to-[#205488]"></div>
            </div>
            
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 pb-20">
                <div class="max-w-4xl mx-auto">
                    <div class="text-white">
                        <div class="flex items-center gap-4 mb-4">
                            {newsItem.data.featured && (
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                    Featured
                                </span>
                            )}
                            <span class="text-sm">
                                {formatDate(newsItem.data.date)}
                            </span>
                        </div>
                        <h1 class="text-4xl md:text-5xl font-bold mb-6">
                            {newsItem.data.title}
                        </h1>
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full overflow-hidden">
                                <img 
                                    src={newsItem.data.author.avatar} 
                                    alt={newsItem.data.author.name}
                                    class="w-full h-full object-cover"
                                />
                            </div>
                            <div class="text-sm">
                                <p class="font-medium">{newsItem.data.author.name}</p>
                                <p class="text-white/80">{newsItem.data.author.bio}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Article Content -->
        <section class="py-20 bg-white">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="max-w-4xl mx-auto">
                    <article class="prose prose-lg max-w-none">
                        <div class="aspect-w-16 aspect-h-9 mb-8 rounded-xl overflow-hidden">
                            <img 
                                src={newsItem.data.thumbnail} 
                                alt={newsItem.data.title}
                                class="w-full h-full object-cover"
                            />
                        </div>
                        
                        <div class="mb-8">
                            <p class="text-xl text-slate-600 leading-relaxed">
                                {newsItem.data.excerpt}
                            </p>
                        </div>

                        <div class="content" set:html={newsItem.body}></div>
                    </article>

                    <!-- Related Posts -->
                    {relatedPosts.length > 0 && (
                        <div class="mt-20">
                            <h2 class="text-3xl font-bold text-[#205488] mb-8">Related News</h2>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {relatedPosts.map((post: NewsPost) => (
                                    <a href={`/news/${post.slug}`} class="bg-white rounded-xl shadow-sm overflow-hidden group hover:shadow-lg transition-all duration-300">
                                        <div class="aspect-w-16 aspect-h-9 bg-gray-100">
                                            <img 
                                                src={post.data.thumbnail} 
                                                alt={post.data.title} 
                                                class="w-full h-full object-cover"
                                            />
                                        </div>
                                        <div class="p-6">
                                            <span class="text-slate-500 text-sm">{formatDate(post.data.date)}</span>
                                            <h3 class="text-xl font-bold text-[#205488] mt-2 mb-3 group-hover:text-[#3270a6] transition-colors">
                                                {post.data.title}
                                            </h3>
                                            <p class="text-slate-600 mb-4">
                                                {post.data.excerpt}
                                            </p>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </section>
    </main>
</Layout>

<style>
    .pattern-grid {
        background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.2) 1px, transparent 0);
        background-size: 24px 24px;
    }

    .logo-pattern {
        background-image: url('../../assets/logo-pattern.png');
    }

    .aspect-w-16 {
        position: relative;
        padding-bottom: 56.25%;
    }

    .aspect-w-16 > * {
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }

    .prose {
        color: #334155;
    }

    .prose h2,
    .prose h3 {
        color: #205488;
        margin-top: 2em;
        margin-bottom: 1em;
    }

    .prose img {
        border-radius: 0.5rem;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
    }

    .prose a {
        color: #205488;
        text-decoration: none;
        font-weight: 500;
    }

    .prose a:hover {
        color: #3270a6;
        text-decoration: underline;
    }
</style>
